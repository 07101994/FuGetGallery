@page
@{    
    var package = await PackageData.GetAsync (RouteData.Values["id"], RouteData.Values["version"]);
    var authors = package.AuthorsOrOwners;

    var framework = package.FindClosestTargetFramework (RouteData.Values["targetFramework"]);
    var asm = framework?.GetAssembly (RouteData.Values["dir"], RouteData.Values["assemblyName"]);
    var isBuildAsm = "build".Equals(RouteData.Values["dir"]);
    var dir = isBuildAsm ? "build" : "lib";
    var asmDef = asm?.Definition;

    var types = asmDef != null ? (IEnumerable<Mono.Cecil.TypeDefinition>)asmDef.MainModule.Types : new Mono.Cecil.TypeDefinition[0];

    var namespaces = types.GroupBy(x => x.Namespace).OrderBy(x => x.Key).Where(x => !string.IsNullOrEmpty(x.Key)).ToList();

    var inputNamespace = (RouteData.Values["namespace"] ?? "").ToString().Trim();

    var ns = namespaces.FirstOrDefault (x => x.Key == inputNamespace);
    if (ns == null) {
        var publicNamespaces = namespaces.Where(n => n.Any(x => x.IsPublic)).OrderByDescending(n => n.Count(x => x.IsPublic));
        ns = publicNamespaces.FirstOrDefault ();
        if (ns == null) {
            ns = namespaces.FirstOrDefault ();
        }
    }

    var inputTypeName = (RouteData.Values["typeName"] ?? "").ToString().Trim();

    var typ = ns?.FirstOrDefault(x => x.Name == inputTypeName);

    var size = framework != null ? framework.SizeInBytes : package.SizeInBytes;

    var nupkgName = package.Id + "." + package.Version + ".nupkg";

    ViewData["Title"] = package.Id;

    var q = Request.Query["q"].FirstOrDefault() ?? "";
    var eq = q.Length > 0 ? "?q=" + Uri.EscapeDataString (q) : "";
    ViewData["q"] = q;

    ViewData["meta"] = new Dictionary<string, string> {
        { "twitter:card", "summary" },
        { "og:url", Request.GetEncodedUrl () },
        { "og:title", package.Id + " " + package.Version },
        { "og:description", package.Description },
        { "og:image", package.IconUrl },
    };
}

<h1>@if (!string.IsNullOrEmpty(package.IconUrl)) {
        <img src="@package.IconUrl" width="64" height="64" style="margin-top:5px;margin-left:-84px;float:left" />
    }
    @package.Id
    <small>@package.Version
    @if (!string.IsNullOrEmpty(authors)) {
        <small style="">by @authors</small>
    }
    </small>
</h1>

@if (!string.IsNullOrEmpty(package.Description)) {
    <p style="font-size: 150%;color:#777;margin-top:-0.25em;margin-bottom:1.25em;">
        @package.Description
    </p>
}

<p>
<a href="@package.DownloadUrl" type="button" class="btn btn-default">
  <span class="glyphicon glyphicon-download" aria-hidden="true"></span> @nupkgName
</a>
@if (!string.IsNullOrEmpty(package.ProjectUrl)) {
    <a href="@package.ProjectUrl" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-link" aria-hidden="true"></span> Project Site
    </a>
}
<a href="https://www.nuget.org/packages/@package.Id/@package.Version" type="button" class="btn btn-default">
    <span class="glyphicon glyphicon-link" aria-hidden="true"></span> NuGet Gallery
</a>
</p>

<pre><code class="xml" style="background-color:transparent">&lt;PackageReference Include="@package.Id" Version="@package.Version" /&gt;</code></pre>

@if (package.Error != null) {
    <div class="">
        <h2>Error reading package</h2>
        <pre>@package.Error</pre>
    </div>
}


<h2 style="margin-top:1.25em;">Frameworks</h2>

<nav style="margin-top:0em;line-height:2.75em;">
@foreach (var tf in package.TargetFrameworks) {
    var active = tf.Moniker == framework.Moniker ? "active" : "";
    var color = tf.Moniker.StartsWith("netstandard") ? "success" : 
                (tf.Moniker.StartsWith("net") ? "info" :
                 (tf.Moniker.StartsWith("portable") ? "warning" : "primary"));
    var bold = active == "active" ? "bold" : "normal";
    var tcolor = active == "active" ? "color:#fff" : "";
    <a class="btn btn-@color btn-med @active" style="font-weight:@bold;@tcolor" role="button" href="/packages/@Uri.EscapeDataString(package.Id)/@Uri.EscapeDataString(package.Version)/@dir/@Uri.EscapeDataString(@tf.Moniker)@eq">@tf.Moniker</a>
}
</nav>

@if (framework != null && framework.Dependencies.Count > 0) {
    <h3>Dependencies</h3>
    <ul style="max-height:10em;overflow:scroll;list-style-type:none;padding:0;white-space:nowrap">
    @foreach (var d in framework.Dependencies.OrderBy(x => x.PackageId)) {
        <li>
            <span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span>&nbsp;<a style="color:#000"
                href="/packages/@Uri.EscapeDataString(d.PackageId)/@Uri.EscapeDataString(d.VersionSpec)@eq">@d.PackageId</a>
        </li>
    }
    </ul>
}

<h2 id="api" style="margin-top:1.25em;margin-bottom:0em">API <small>@size.ToString("#,0") bytes</small></h2>

<div class="row">

@if (framework != null) {
<div class="col-xs-12 col-sm-3">
    @if (framework.Assemblies.Count > 0) {
        <h3>Assemblies</h3>
        <ul style="max-height:10em;overflow:scroll;list-style-type:none;padding:0;white-space:nowrap">
        @foreach (var a in framework.Assemblies.OrderBy(x => x.FileName)) {
            var bold = !isBuildAsm && a.FileName == asm?.FileName ? "bold" : "normal";
            var color = bold == "bold" ? "#000" : "#777";
            <li>
                <span class="glyphicon glyphicon-file" aria-hidden="true"></span>&nbsp;<a style="font-weight:@bold;color:@color;"
                    href="/packages/@Uri.EscapeDataString(package.Id)/@Uri.EscapeDataString(package.Version)/lib/@Uri.EscapeDataString(framework.Moniker)/@Uri.EscapeDataString(a.FileName)@eq">@a.FileName</a>
            </li>
        }
        </ul>
    }
    @if (framework.BuildAssemblies.Count > 0) {
        <h3>Build Assemblies</h3>
        <ul style="max-height:10em;overflow:scroll;list-style-type:none;padding:0;white-space:nowrap">
        @foreach (var a in framework.BuildAssemblies.OrderBy(x => x.FileName)) {
            var bold = isBuildAsm && a.FileName == asm?.FileName ? "bold" : "normal";
            var color = bold == "bold" ? "#000" : "#777";
            <li>
                <span class="glyphicon glyphicon-file" aria-hidden="true"></span>&nbsp;<a style="font-weight:@bold;color:@color;"
                    href="/packages/@Uri.EscapeDataString(package.Id)/@Uri.EscapeDataString(package.Version)/build/@Uri.EscapeDataString(framework.Moniker)/@Uri.EscapeDataString(a.FileName)@eq">@a.FileName</a>
            </li>
        }
        </ul>
    }
</div>
}

@if (asmDef != null) {
    <div class="col-xs-12 col-sm-9">
        <h3>Namespaces</h3>
        <ul style="max-height:10em;overflow:scroll;list-style-type:none;padding:0;white-space:nowrap">
        @foreach (var n in namespaces) {
            var bold = n.Key == ns?.Key ? "bold" : "normal";
            var isPublic = n.Any(x => x.IsPublic);
            var color = bold == "bold" ? "#000" : (isPublic ? "#777" : "#CCC");
            <li>
                <span class="glyphicon glyphicon-book" aria-hidden="true"></span>&nbsp;<a style="font-weight:@bold;color:@color;"
                    href="/packages/@Uri.EscapeDataString(package.Id)/@Uri.EscapeDataString(package.Version)/@dir/@Uri.EscapeDataString(framework.Moniker)/@Uri.EscapeDataString(asm.FileName)/@Uri.EscapeDataString(n.Key)@eq">@n.Key</a>
            </li>
        }
        </ul>
    </div>
}

</div>

<div class="row">

@if (ns != null) {
    <div class="col-xs-12 col-sm-3">
        <h3 id="types" style="margin-top:2em;">Types</h3>
        <ul style="list-style-type:none;padding:0;white-space:nowrap">
        @foreach (var t in ns.OrderBy(x => x.Name)) {
            var bold = t.Name == typ?.Name ? "bold" : "normal";
            var isPublic = t.IsPublic;
            var isEnum = t.IsEnum;
            var isStruct = !isEnum && t.IsValueType;
            var isDel = !(isEnum || isStruct) && t.IsDelegate();
            var isIface = !(isEnum || isStruct || isDel) && (t.IsInterface || t.IsAbstract);
            var icon = isEnum ? "menu-hamburger" : (isDel ? "flash" : (isStruct ? "unchecked" : (isIface ? "star-empty" : "star")));
            var color = bold == "bold" ? "#000" : (isPublic ? "#777" : "#CCC");
            var active = bold == "bold" ? "active" : "";
            <li>
            <a class="@active" style="font-weight:@bold;color:@color;"
            href="/packages/@Uri.EscapeDataString(package.Id)/@Uri.EscapeDataString(package.Version)/@dir/@Uri.EscapeDataString(framework.Moniker)/@Uri.EscapeDataString(asm.FileName)/@Uri.EscapeDataString(ns.Key)/@Uri.EscapeDataString(t.Name)@eq#api">
            <span class="glyphicon glyphicon-@icon" aria-hidden="true"></span>&nbsp;@t.Name</a>
            </li>
        }
        </ul>
    </div>
}



@if (typ != null) {
    var docs = framework.GetTypeDocumentation(typ);
    <div class="col-xs-12 col-sm-9" id="code">
        <h3 id="type" style="margin-top:2em;">@typ.FullName</h3>
        <p>@docs.SummaryText</p>
        <pre style="tab-size: 4;line-height:1.3em;"><code class="csharp" style="white-space: pre;word-wrap: normal;background-color:transparent">@asm.DecompileType(typ)</code></pre>
    </div>
}

</div>




